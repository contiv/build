---
# This role contains tasks for configuring and starting docker service
# XXX: setup environment for docker service like proxy etc

- name: copy systemd units for docker tcp socket settings
  template: src=docker-tcp.j2 dest=/etc/systemd/system/docker-tcp.socket

- name: remove the key file, if any. It shall be regenerated by docker on restart
  file:  name=/etc/docker/key.json  state=absent

- name: setup proxy
  shell: mkdir -p /etc/systemd/system/docker.service.d && echo "[Service]" | sudo tee /etc/systemd/system/docker.service.d/http-proxy.conf && echo "Environment=\"no_proxy=192.168.0.0/16,localhost,127.0.0.0/8,127.0.0.1,netmaster\" \"http_proxy=$http_proxy\" \"https_proxy=$https_proxy\"" | sudo tee -a /etc/systemd/system/docker.service.d/http-proxy.conf
- name: start docker with tcp socket
  shell: systemctl daemon-reload && systemctl stop docker && systemctl start docker-tcp.socket && systemctl start docker
